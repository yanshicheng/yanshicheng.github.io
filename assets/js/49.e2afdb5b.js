(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{403:function(s,a,t){"use strict";t.r(a);var n=t(4),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"流量迁移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#流量迁移"}},[s._v("#")]),s._v(" 流量迁移")]),s._v(" "),a("p",[s._v("通过在路由中配置运行时对象选择特定路由以及响应集群的概率的变动，从而实现降虚拟主机中特定路由的流量逐渐从一个集群迁移到另一个集群。\n在路由匹配方面，envoy 在检测到第一个匹配时终止后续检测，因而，流量迁移应该如下配置")]),s._v(" "),a("ul",[a("li",[s._v("配置两个适用相同的match条件的路由条目")]),s._v(" "),a("li",[s._v("在第一个路由条目中配置 runtime_fraction 对象，并设定其流量比例。")]),s._v(" "),a("li",[s._v("改流量比例之外的请求将由第二条路由接收\n用户可以不断通过 Envoy 的 admin 接口修改 runtime_fraction 对象的值完成流量迁移。\n"),a("code",[s._v("curl -X POST http://envoy_ip:port/runtime_modify?key1=val1&key2=val2")])])]),s._v(" "),a("h3",{attrs:{id:"envoy-配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#envoy-配置文件"}},[s._v("#")]),s._v(" envoy 配置文件")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("admin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("profile_path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /tmp/envoy.prof  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置 Envoy 管理接口的性能分析文件路径，用于存储性能分析数据")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("access_log_path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /dev/stdout   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置 Envoy 管理接口的访问日志路径，这里设置为标准输出")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("socket_address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.0.0.0           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置管理接口的监听地址，0.0.0.0 表示监听所有网络接口")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port_value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9901")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 管理接口的监听端口号，这里设置为 9901")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("layered_runtime")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("layers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" admin\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("admin_layer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 管理层的运行时配置，可以通过此层动态更新配置，便于管理")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("static_resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("listeners")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" listener_0\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("socket_address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.0.0.0         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置监听器的监听地址，0.0.0.0 表示监听所有网络接口")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port_value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监听器的端口号，这里设置为 80，表示 HTTP 默认端口")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("filter_chains")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("filters")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" envoy.filters.network.http_connection_manager\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("typed_config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"@type"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stat_prefix")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ingress_http     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置统计前缀，用于标识该 HTTP 连接管理器的统计信息")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("codec_type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" AUTO              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 自动选择 HTTP 编解码类型，可以是 HTTP1 或 HTTP2")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("route_config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" local_route           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 路由配置的名称")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("virtual_hosts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backendApp          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟主机的名称")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("domains")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该虚拟主机匹配的域名，* 表示匹配所有域名")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("routes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("match")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("prefix")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/"')]),s._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 路由匹配的前缀路径，这里匹配所有路径")]),s._v("\n                  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("runtime_fraction")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("default_value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("numerator")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认百分比值，100 表示 100%")]),s._v("\n                      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("denominator")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" HUNDRED\n                    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("runtime_key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"backendApp.runtime_fraction"')]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 运行时控制的键值，用于动态调整百分比")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# runtime_fraction 用于动态控制流量的分配。可以在运行时通过管理接口")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 动态调整该键值，以便在两个不同的路由之间分配流量。这里的配置表示默认情况下")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将 100% 的流量路由到 backendApp-v10 集群，0% 的流量路由到 backendApp-v20 集群。")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("route")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backendApp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v10 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当 runtime_fraction 的值为 100% 时，路由到 backendApp-v10 集群")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("match")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("prefix")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/"')]),s._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 匹配所有路径")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("route")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backendApp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v20 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 其余情况下，路由到 backendApp-v20 集群")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http_filters")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" envoy.filters.http.router\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("typed_config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"@type"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" type.googleapis.com/envoy.extensions.filters.http.router.v3.Router "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置 HTTP 路由过滤器")]),s._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("clusters")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backendApp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v10\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("connect_timeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.25s       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置连接超时时间为 0.25 秒")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" STRICT_DNS             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群类型为 STRICT_DNS，严格的 DNS 模式，会动态解析 DNS 并更新端点")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lb_policy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ROUND_ROBIN       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 负载均衡策略为 ROUND_ROBIN，轮询方式分配请求")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("load_assignment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backendApp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v10 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 负载分配集群的名称")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("endpoints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lb_endpoints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("endpoint")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("socket_address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.31.1.11 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 后端服务的 IP 地址")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port_value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 后端服务的端口号")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backendApp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v20\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("connect_timeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.25s       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置连接超时时间为 0.25 秒")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" STRICT_DNS             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群类型为 STRICT_DNS，严格的 DNS 模式，会动态解析 DNS 并更新端点")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lb_policy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ROUND_ROBIN       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 负载均衡策略为 ROUND_ROBIN，轮询方式分配请求")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("load_assignment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backendApp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v20 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 负载分配集群的名称")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("endpoints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lb_endpoints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("endpoint")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("socket_address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.31.1.12 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 后端服务的 IP 地址")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port_value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 后端服务的端口号")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br")])]),a("h3",{attrs:{id:"docker-compose"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose"}},[s._v("#")]),s._v(" docker-compose")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3.3'")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("client")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" harbor.ikubeops.local/public/network"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("multitool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/bin/bash'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-c'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sleep INFINITE'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("envoymesh")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ipv4_address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.31.1.100\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("aliases")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" client\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("depends_on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" webserver01\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" webserver02\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" envoy\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("envoy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" m.daocloud.io/docker.io/envoyproxy/envoy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("v1.30.2\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ./envoy.yaml"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/etc/envoy/envoy.yaml\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ENVOY_UID=0\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ENVOY_GID=0\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("envoymesh")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ipv4_address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.31.1.10\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("aliases")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" front"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("proxy\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("depends_on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" webserver01\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" webserver02\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("webserver01")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" harbor.ikubeops.local/public/sample"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("backend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("v3.0\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" WEB_ADDR=0.0.0.0\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" WEB_PORT=8080\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" WEB_VERSION=v10\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" WEB_NAME=backend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v10\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" webserver01\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("envoymesh")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ipv4_address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.31.1.11\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("aliases")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" webserver01\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("webserver02")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" harbor.ikubeops.local/public/sample"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("backend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("v3.0\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" WEB_ADDR=0.0.0.0\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" WEB_PORT=8080\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" WEB_VERSION=v20\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" WEB_NAME=backend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v20\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" webserver02\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("envoymesh")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ipv4_address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.31.1.12\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("aliases")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" webserver02\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("envoymesh")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("driver")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bridge\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ipam")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("subnet")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.31.1.0/24\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br")])]),a("h3",{attrs:{id:"测试逻辑"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试逻辑"}},[s._v("#")]),s._v(" 测试逻辑")]),s._v(" "),a("p",[s._v("定义两个后端集群，分别为 V10 和 V20 通过 admin 修改 阈值控制流量比例。\n一个终端模拟请求，另一个进行修改参数\n模拟请求")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("❯ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v("  01-traffic-shifting-client-1 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\nbash-5.1"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# while true;do curl 172.31.1.10/ss && sleep  1; done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("修改阈值如下")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("❯ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v("  01-traffic-shifting-client-1 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\nbash-5.1"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 172.31.1.10:9901/runtime")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"layers"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"entries"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nbash-5.1"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl -X POST 172.31.1.10:9901/runtime_modify?backendApp.runtime_fraction=95")]),s._v("\nOK\nbash-5.1"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 172.31.1.10:9901/runtime")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"layers"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"entries"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"backendApp.runtime_fraction"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"final_value"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"95"')]),s._v(",\n   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"layer_values"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"95"')]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nbash-5.1"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl -X POST 172.31.1.10:9901/runtime_modify?backendApp.runtime_fraction=30")]),s._v("\nOK\nbash-5.1"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 172.31.1.10:9901/runtime")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"entries"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"backendApp.runtime_fraction"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"layer_values"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"30"')]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"final_value"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"30"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"layers"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br")])]),a("h2",{attrs:{id:"流量分割"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#流量分割"}},[s._v("#")]),s._v(" 流量分割")]),s._v(" "),a("p",[s._v("HTTP route 过滤器支持在一个路由中指定多个上游具有权重属性的集群，而后将流量基于权重调度值此些集群其中之一。\n类似流量迁移，流量分割中，分配给每个集群的权重也可以使用运行时参数进行调整。")]),s._v(" "),a("h3",{attrs:{id:"envoy-配置文件-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#envoy-配置文件-2"}},[s._v("#")]),s._v(" envoy 配置文件")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("admin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("profile_path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /tmp/envoy.prof  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置 Envoy 管理接口的性能分析文件路径，用于存储性能分析数据")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("access_log_path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /dev/stdout   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置 Envoy 管理接口的访问日志路径，这里设置为标准输出")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("socket_address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.0.0.0           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置管理接口的监听地址，0.0.0.0 表示监听所有网络接口")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port_value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9901")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 管理接口的监听端口号，这里设置为 9901")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("layered_runtime")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("layers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" admin\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("admin_layer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 管理层的运行时配置，可以通过此层动态更新配置，便于管理")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("static_resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("listeners")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" listener_0\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("socket_address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.0.0.0         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置监听器的监听地址，0.0.0.0 表示监听所有网络接口")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port_value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监听器的端口号，这里设置为 80，表示 HTTP 默认端口")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("filter_chains")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("filters")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" envoy.filters.network.http_connection_manager\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("typed_config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"@type"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stat_prefix")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ingress_http     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置统计前缀，用于标识该 HTTP 连接管理器的统计信息")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("codec_type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" AUTO              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 自动选择 HTTP 编解码类型，可以是 HTTP1 或 HTTP2")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("route_config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" local_route           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 路由配置的名称")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("virtual_hosts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backend_app         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟主机的名称")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("domains")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该虚拟主机匹配的域名，* 表示匹配所有域名")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("routes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("match")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("prefix")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/"')]),s._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 路由匹配的前缀路径，这里匹配所有路径")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("route")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("weighted_clusters")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加权集群路由配置")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("clusters")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backend_app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v10\n                      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("weight")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 初始情况下将 100% 的流量分配给 backend_app-v10")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backend_app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v20\n                      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("weight")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 初始情况下将 0% 的流量分配给 backend_app-v20")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("total_weight")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 总权重为 100")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("runtime_key_prefix")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"routing.traffic_split.backend_app"')]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用于动态调整流量分配的运行时键前缀")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http_filters")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" envoy.filters.http.router\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("typed_config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"@type"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" type.googleapis.com/envoy.extensions.filters.http.router.v3.Router "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置 HTTP 路由过滤器")]),s._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("clusters")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backend_app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v10\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("connect_timeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.25s       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置连接超时时间为 0.25 秒")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" STRICT_DNS             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群类型为 STRICT_DNS，严格的 DNS 模式，会动态解析 DNS 并更新端点")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lb_policy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ROUND_ROBIN       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 负载均衡策略为 ROUND_ROBIN，轮询方式分配请求")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("load_assignment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backend_app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v10 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 负载分配集群的名称")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("endpoints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lb_endpoints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("endpoint")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("socket_address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.31.1.11 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 后端服务的 IP 地址")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port_value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 后端服务的端口号")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backend_app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v20\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("connect_timeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.25s       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置连接超时时间为 0.25 秒")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" STRICT_DNS             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群类型为 STRICT_DNS，严格的 DNS 模式，会动态解析 DNS 并更新端点")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lb_policy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ROUND_ROBIN       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 负载均衡策略为 ROUND_ROBIN，轮询方式分配请求")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("load_assignment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backend_app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v20 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 负载分配集群的名称")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("endpoints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lb_endpoints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("endpoint")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("socket_address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 172.31.1.12 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 后端服务的 IP 地址")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port_value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 后端服务的端口号")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br")])]),a("h3",{attrs:{id:"docker-compose-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-2"}},[s._v("#")]),s._v(" docker-compose")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("version: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3.3'")]),s._v("\n\nservices:\n  client:\n    image: harbor.ikubeops.local/public/network-multitool:latest\n    command: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/bin/bash'")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-c'")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sleep INFINITE'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    networks:\n      envoymesh:\n        ipv4_address: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.31")]),s._v(".1.100\n        aliases:\n          - client\n    depends_on:\n      - webserver01\n      - webserver02\n      - envoy\n  envoy:\n    image: m.daocloud.io/docker.io/envoyproxy/envoy:v1.30.2\n    volumes:\n      - ./envoy.yaml:/etc/envoy/envoy.yaml\n    environment:\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ENVOY_UID")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ENVOY_GID")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n    networks:\n      envoymesh:\n        ipv4_address: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.31")]),s._v(".1.10\n        aliases:\n          - front-proxy\n    depends_on:\n      - webserver01\n      - webserver02\n  webserver01:\n    image: harbor.ikubeops.local/public/sample-backend:v3.0\n    environment:\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WEB_ADDR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WEB_PORT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WEB_VERSION")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("v10\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WEB_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("backend-v10\n    hostname: webserver01\n    networks:\n      envoymesh:\n        ipv4_address: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.31")]),s._v(".1.11\n        aliases:\n          - webserver01\n  webserver02:\n    image: harbor.ikubeops.local/public/sample-backend:v3.0\n    environment:\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WEB_ADDR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WEB_PORT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WEB_VERSION")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("v20\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WEB_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("backend-v20\n    hostname: webserver02\n    networks:\n      envoymesh:\n        ipv4_address: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.31")]),s._v(".1.12\n        aliases:\n          - webserver02\n\nnetworks:\n  envoymesh:\n    driver: bridge\n    ipam:\n      config:\n        - subnet: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.31")]),s._v(".1.0/24\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br")])]),a("h3",{attrs:{id:"测试逻辑-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试逻辑-2"}},[s._v("#")]),s._v(" 测试逻辑")]),s._v(" "),a("p",[s._v("定义两个后端集群，分别为 V10 和 V20 通过 admin 修改 阈值控制流量比例。\n一个终端模拟请求，另一个进行修改参数\n模拟请求](<定义两个后端集群，分别为 V10 和 V20 通过 admin 修改 阈值控制流量比例。\n一个终端模拟请求，另一个进行修改参数\n模拟请求")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("❯ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v("  01-traffic-shifting-client-1 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\nbash-5.1"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# while true;do curl 172.31.1.10/ss && sleep  1; done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("修改阈值如下")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("❯ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v("  02-traffic-weight-client-1 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\nbash-5.1"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 172.31.1.10:9901/runtime")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"entries"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"layers"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nbash-5.1"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  curl -X POST '172.31.1.10:9901/runtime_modify?routing.traffic_split.backend_app.backend_app-v20=50&routing.traffic_split.backend_app.backend_app-v10=50'")]),s._v("\nOK\nbash-5.1"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 172.31.1.10:9901/runtime")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"entries"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"routing.traffic_split.backend_app.backend_app-v20"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"final_value"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"50"')]),s._v(",\n   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"layer_values"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"50"')]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"routing.traffic_split.backend_app.backend_app-v10"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"layer_values"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"50"')]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"final_value"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"50"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"layers"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br")])]),a("h2",{attrs:{id:"流量镜像"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#流量镜像"}},[s._v("#")]),s._v(" 流量镜像")]),s._v(" "),a("p",[s._v("Envoy 的流量镜像（Traffic Mirroring）是一种强大的功能，允许将入站或出站流量的副本发送到镜像集群，而不影响原始请求的处理。这种技术为测试、监控和分析提供了强大的工具。\nEnvoy 的流量镜像功能为现代微服务架构提供了强大的工具，使开发团队能够在真实环境中安全地进行测试、分析和优化。通过合理应用这些最佳实践，可以显著提高系统的可靠性、性能和安全性，同时加速创新和问题解决的过程。")]),s._v(" "),a("h3",{attrs:{id:"核心应用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心应用场景"}},[s._v("#")]),s._v(" 核心应用场景")]),s._v(" "),a("h4",{attrs:{id:"生产环境验证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#生产环境验证"}},[s._v("#")]),s._v(" 生产环境验证")]),s._v(" "),a("p",[s._v("在不影响用户的情况下，使用实际生产流量验证新版本或配置。")]),s._v(" "),a("ol",[a("li",[s._v("部署新版本到隔离环境")]),s._v(" "),a("li",[s._v("配置 Envoy 将生产流量镜像到新环境")]),s._v(" "),a("li",[s._v("逐步增加镜像流量比例（如 1% → 10% → 50% → 100%）")]),s._v(" "),a("li",[s._v("比较新旧版本的性能指标和响应\n关键指标：")])]),s._v(" "),a("ul",[a("li",[s._v("响应时间差异")]),s._v(" "),a("li",[s._v("错误率对比")]),s._v(" "),a("li",[s._v("资源使用情况\n优势：")]),s._v(" "),a("li",[s._v("真实流量测试，无需模拟数据")]),s._v(" "),a("li",[s._v("零风险验证")]),s._v(" "),a("li",[s._v("早期问题检测")])]),s._v(" "),a("h4",{attrs:{id:"a-b-测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#a-b-测试"}},[s._v("#")]),s._v(" A/B 测试")]),s._v(" "),a("p",[s._v("同时测试多个版本或配置，评估其性能和用户体验。\n实施步骤：")]),s._v(" "),a("ol",[a("li",[s._v("部署多个版本（A、B、C...）")]),s._v(" "),a("li",[s._v("配置 Envoy 将流量按比例镜像到各版本")]),s._v(" "),a("li",[s._v("收集和分析各版本的性能数据和用户反馈")]),s._v(" "),a("li",[s._v("基于数据做出决策\n关键指标：")])]),s._v(" "),a("ul",[a("li",[s._v("用户参与度")]),s._v(" "),a("li",[s._v("转化率")]),s._v(" "),a("li",[s._v("性能指标（加载时间、响应时间）\n优势：")]),s._v(" "),a("li",[s._v("数据驱动决策")]),s._v(" "),a("li",[s._v("精确比较不同版本")]),s._v(" "),a("li",[s._v("优化用户体验")])]),s._v(" "),a("h4",{attrs:{id:"性能基准测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#性能基准测试"}},[s._v("#")]),s._v(" 性能基准测试")]),s._v(" "),a("p",[s._v("使用镜像流量进行大规模性能测试，而不影响生产环境。\n实施步骤：")]),s._v(" "),a("ol",[a("li",[s._v("搭建独立的性能测试环境")]),s._v(" "),a("li",[s._v("配置 Envoy 将全量或部分生产流量镜像到测试环境")]),s._v(" "),a("li",[s._v("使用流量放大器增加负载")]),s._v(" "),a("li",[s._v("监控和分析系统在高负载下的表现\n关键指标：")])]),s._v(" "),a("ul",[a("li",[s._v("吞吐量")]),s._v(" "),a("li",[s._v("延迟")]),s._v(" "),a("li",[s._v("资源利用率（CPU、内存、网络）")]),s._v(" "),a("li",[s._v("错误率\n优势：")]),s._v(" "),a("li",[s._v("真实流量模式")]),s._v(" "),a("li",[s._v("安全进行极限测试")]),s._v(" "),a("li",[s._v("识别性能瓶颈")])]),s._v(" "),a("h4",{attrs:{id:"安全审计与威胁检测"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安全审计与威胁检测"}},[s._v("#")]),s._v(" 安全审计与威胁检测")]),s._v(" "),a("p",[s._v("将流量镜像到专门的安全分析系统，增强实时威胁检测能力。\n实施步骤：")]),s._v(" "),a("ol",[a("li",[s._v("部署专用的安全分析集群")]),s._v(" "),a("li",[s._v("配置 Envoy 将流量镜像到该集群")]),s._v(" "),a("li",[s._v("使用高级安全工具（如 IDS/IPS）分析镜像流量")]),s._v(" "),a("li",[s._v("设置实时警报系统\n关键组件：")])]),s._v(" "),a("ul",[a("li",[s._v("入侵检测系统（IDS）")]),s._v(" "),a("li",[s._v("异常行为检测器")]),s._v(" "),a("li",[s._v("日志分析工具\n优势：")]),s._v(" "),a("li",[s._v("不影响生产流量的深度安全分析")]),s._v(" "),a("li",[s._v("实时威胁检测")]),s._v(" "),a("li",[s._v("增强事件响应能力")])]),s._v(" "),a("h4",{attrs:{id:"灰度发布-金丝雀发布"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#灰度发布-金丝雀发布"}},[s._v("#")]),s._v(" 灰度发布 & 金丝雀发布")]),s._v(" "),a("p",[s._v("结合流量镜像和流量分割，实现精确控制的灰度发布。\n实施步骤：")]),s._v(" "),a("ol",[a("li",[s._v("部署新版本")]),s._v(" "),a("li",[s._v("配置 Envoy 将小比例实际流量路由到新版本")]),s._v(" "),a("li",[s._v("同时将较大比例流量镜像到新版本进行全面分析")]),s._v(" "),a("li",[s._v("基于分析结果逐步增加实际流量比例\n关键指标：")])]),s._v(" "),a("ul",[a("li",[s._v("错误率")]),s._v(" "),a("li",[s._v("性能指标")]),s._v(" "),a("li",[s._v("用户反馈\n优势：")]),s._v(" "),a("li",[s._v("降低发布风险")]),s._v(" "),a("li",[s._v("快速回滚能力")]),s._v(" "),a("li",[s._v("全面验证新版本")])]),s._v(" "),a("h4",{attrs:{id:"机器学习模型优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#机器学习模型优化"}},[s._v("#")]),s._v(" 机器学习模型优化")]),s._v(" "),a("p",[s._v("利用镜像流量训练和优化机器学习模型，特别适用于推荐系统、反欺诈等场景。")]),s._v(" "),a("ol",[a("li",[s._v("部署模型训练环境")]),s._v(" "),a("li",[s._v("配置 Envoy 将流量镜像到该环境")]),s._v(" "),a("li",[s._v("使用镜像数据实时训练和更新模型")]),s._v(" "),a("li",[s._v("比较新旧模型性能，并在适当时切换\n关键指标：")])]),s._v(" "),a("ul",[a("li",[s._v("模型准确率")]),s._v(" "),a("li",[s._v("预测速度")]),s._v(" "),a("li",[s._v("资源消耗\n优势：")]),s._v(" "),a("li",[s._v("使用实时数据持续优化模型")]),s._v(" "),a("li",[s._v("无需额外的数据收集过程")]),s._v(" "),a("li",[s._v("快速适应变化的模式")])]),s._v(" "),a("h4",{attrs:{id:"隔离测试数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#隔离测试数据库"}},[s._v("#")]),s._v(" 隔离测试数据库")]),s._v(" "),a("p",[s._v("在数据处理相关的业务中，隔离测试数据库是流量镜像的一个关键应用场景。这种方法的工作原理和优势如下：")]),s._v(" "),a("ol",[a("li",[s._v("设置独立的测试数据库：\n创建一个与生产数据库结构相同但内容为空的数据库。\n加载特定的测试数据集。")]),s._v(" "),a("li",[s._v("镜像流量处理：\n将生产环境的流量镜像到测试环境。\n所有数据操作都在测试数据库上执行，不影响生产数据。\n优势：")])]),s._v(" "),a("ul",[a("li",[s._v("数据安全：避免了对生产数据的意外修改或泄露风险。")]),s._v(" "),a("li",[s._v("灵活性：可以根据需要自由设置和修改测试数据。")]),s._v(" "),a("li",[s._v("性能影响最小化：生产环境的性能不受测试操作的影响。\n实现方法：")]),s._v(" "),a("li",[s._v("使用 Envoy 的流量镜像功能将请求复制到测试环境。")]),s._v(" "),a("li",[s._v("在测试环境中配置应用程序使用专门的测试数据库。")]),s._v(" "),a("li",[s._v("可以通过修改数据库连接配置或使用不同的环境变量来实现。\n注意事项：")]),s._v(" "),a("li",[s._v("确保测试数据库的模式（schema）与生产数据库保持同步。")]),s._v(" "),a("li",[s._v("定期更新测试数据，以反映生产环境的最新状态。")]),s._v(" "),a("li",[s._v("监控镜像流量对测试数据库的影响，必要时调整资源配置。\n通过这种方式，开发团队可以在近乎真实的环境中进行测试，同时完全隔离生产数据，大大降低了测试过程中数据泄露或损坏的风险。这对于需要严格数据保护的应用，如金融系统或涉及个人隐私的应用，尤其重要。")])]),s._v(" "),a("h3",{attrs:{id:"测试逻辑-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试逻辑-3"}},[s._v("#")]),s._v(" 测试逻辑")]),s._v(" "),a("p",[s._v("定义两个后端集群，分别为 V10 和 V20 通过 admin 修改 阈值控制流量比例。\n一个终端模拟请求，另一个进行修改参数\n模拟请求](<定义两个后端集群，分别为 V10 和 V20 通过 admin 修改 阈值控制流量比例。\n一个终端模拟请求，另一个进行修改参数\n模拟请求")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("❯ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v("  01-traffic-shifting-client-1 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\nbash-5.1"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# while true;do curl 172.31.1.10/ss && sleep  1; done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("修改阈值如下")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("❯ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v("  03-traffic-mirror-client-1 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\nbash-5.1"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 172.31.1.10:9901/runtime")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"layers"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"entries"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nbash-5.1"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl -X POST '172.31.1.10:9901/runtime_modify?&routing.request_mirror.backend_app=100'")]),s._v("\nOK\nbash-5.1"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl 172.31.1.10:9901/runtime")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"layers"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"entries"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"routing.request_mirror.backend_app"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"layer_values"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"100"')]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n   "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"final_value"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"100"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[s._v("如下图已经进行了百分百的流量镜像\n"),a("img",{attrs:{src:"https://wiki-images.yanshicheng.com/static/202408040010468.png",alt:"image.png"}})])])}),[],!1,null,null,null);a.default=e.exports}}]);